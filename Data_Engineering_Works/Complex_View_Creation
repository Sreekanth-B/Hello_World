# Creating the View based on the aggregations defined on the required database.

USE <Database_Name>;

set hive.auto.convert.join = false;
set hive.cli.print.header=true;

CREATE VIEW IF NOT EXISTS <View_name> AS 
  SELECT 
    commontable.process_timestamp AS Process_Timestamp,
    commontable.rowid AS FileName,
    commontable.common_value_map['_System_Serial_Number'] AS Engine_Serial_Number,
    commontable.common_value_map['_Calibration_Version'] AS Calibration_Software_Phase,
    commontable.common_value_map['_ECM_Code'] AS ECM_Code,
	to_date(commontable.occurrence_timestamp) AS Occurrence_Date,
	ath_sectiontable.parameter_value_map['_start_soot_fill_monitor_status'] AS Starting_Diesel_Particulate_Filter_Soot_Load,
    ath_sectiontable.parameter_value_map["_end_soot_fill_monitor_status"] AS Ending_Diesel_Particulate_Filter_Soot_Load,
	FROM(
    SELECT
      ROWID,
      OCCURRENCE_TIMESTAMP,
      PROCESS_TIMESTAMP,
      tags[0] as Record_number,
      default.collect(name,value[0]) AS parameter_value_map, 
      default.collect(name,unit) AS parameter_unit_map 
    FROM insite_raw.insite_master  
    WHERE name IN ("_start_soot_fill_monitor_status", "_end_soot_fill_monitor_status", "_start_doc_inlet_temperature", "_maximum_doc_out_temperature_during", "_maximum_dpf_out_temperature_during", "_maximum_dpf_delta_p_during") 
    GROUP BY ROWID, OCCURRENCE_TIMESTAMP, PROCESS_TIMESTAMP, tags[0] ) ath_sectiontable 
    LEFT OUTER JOIN 
    (SELECT 
      ROWID, 
      OCCURRENCE_TIMESTAMP, 
      PROCESS_TIMESTAMP, 
      default.collect(name,value[0]) AS common_value_map 
    FROM insite_raw.insite_master 
    WHERE ( array_contains(tags,"Header") OR ( (array_contains(tags,"root") OR array_contains(tags,"Root")) AND (name IN ("_System_Serial_Number", "_Calibration_Version", "_ECM_Code", "_ECM_Name", "_System_Model", "_VIN_Or_Equipment_Serial_Number", "_ECM_Run_Time", "_ECM_Real_Time") ) ) ) 
    GROUP BY ROWID, OCCURRENCE_TIMESTAMP, PROCESS_TIMESTAMP ) commontable 
ON commontable.rowid=ath_sectiontable.rowid AND commontable.occurrence_timestamp=ath_sectiontable.occurrence_timestamp AND commontable.process_timestamp=ath_sectiontable.process_timestamp;
