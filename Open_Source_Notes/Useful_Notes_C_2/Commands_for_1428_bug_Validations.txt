

*********		Execute the below commands in sequence of their number specification 


=====1


val sqlContext = new org.apache.spark.sql.SQLContext(sc);

val tripInfoDF = spark.sql("select * from quality_engine_features.ins_trip_info_mda_master")

val EAinfoDF = spark.sql("select * from quality_engine_features.INS_ENGINE_ABUSE_JSON_MDA_MASTER")


=====2

def lToGal = udf((value:String) => {

if (value != null) 
(value.toFloat * 0.2641).toString
else 
value
    })


def kmToMi = udf((value:String) => {

if (value != null) 
(value.toDouble * 0.6213).toString
else 
value
    })


def kmPerLToMiPerGal = udf((value:String) => {

if (value != null) 
(value.toDouble * 2.35214583).toString
else 
value
    })

def secToHr(value: String): String = (value.toDouble / 3600).toString


def secToHr = udf((value:String) => {

if (value != null) 
(value.toDouble / 3600).toString
else 
value
    })


	
	
def getPercent = udf((param1: Double, param2: Double) => {
      val percent = param1*100 / param2
      if(percent != null && percent <= 100) percent
        // HV158 - Mar 11 2019 - Refer XDS 353 Fixing formula only, Decision pending on PERCENT > 100
        // HV158 - Apr 16, 2019 - XDS 1291 capping to 100
      else 100.00
    })

	

===== 3

val tripInfoCalDF = tripInfoDF.withColumn("INS_TI_AFTERTREATMENT_DIESEL_EXHAUST_FLUID_USED_GAL",lToGal($"INS_TI_AFTERTREATMENT_DIESEL_EXHAUST_FLUID_USED_LITRE")).
      withColumn("INS_TI_COAST_FUEL_USED_GAL",lToGal($"INS_TI_COAST_FUEL_USED_LITRE")).
      withColumn("INS_TI_CRUISE_CONTROL_FUEL_USED_GAL",lToGal($"INS_TI_CRUISE_CONTROL_FUEL_USED_LITRE")).
      withColumn("INS_TI_DRIVE_FUEL_USED_GAL",lToGal($"INS_TI_DRIVE_FUEL_USED_LITRE")).
      withColumn("INS_TI_FUEL_CONSUMED_FOR_AFTERTREATMENT_INJECTION_GAL",lToGal($"INS_TI_FUEL_CONSUMED_FOR_AFTERTREATMENT_INJECTION_LITRE")).
      withColumn("INS_TI_FUEL_USED_GAL",lToGal($"INS_TI_FUEL_USED_LITRE")).
      withColumn("INS_TI_GEAR_DOWN_FUEL_USED_GAL",lToGal($"INS_TI_GEAR_DOWN_FUEL_USED_LITRE")).
      withColumn("INS_TI_IDLE_FUEL_USED_GAL",lToGal($"INS_TI_IDLE_FUEL_USED_LITRE")).
      withColumn("INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_FUEL_USED_GAL",lToGal($"INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_FUEL_USED_LITRE")).
      withColumn("INS_TI_PREDICTIVE_CRUISE_CONTROL_FUEL_USED_GAL",lToGal($"INS_TI_PREDICTIVE_CRUISE_CONTROL_FUEL_USED_LITRE")).
      withColumn("INS_TI_TOP_GEAR_FUEL_USED_GAL",lToGal($"INS_TI_TOP_GEAR_FUEL_USED_LITRE")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_1_FUEL_USED_GAL",lToGal($"INS_TI_VEHICLE_OVERSPEED_1_FUEL_USED_LITRE")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_2_FUEL_USED_GAL",lToGal($"INS_TI_VEHICLE_OVERSPEED_2_FUEL_USED_LITRE")).
      withColumn("INS_TI_COAST_DISTANCE_MI", kmToMi($"INS_TI_COAST_DISTANCE_KM")).
      withColumn("INS_TI_CRUISE_CONTROL_DISTANCE_MI", kmToMi($"INS_TI_CRUISE_CONTROL_DISTANCE_KM")).
      withColumn("INS_TI_ECM_DISTANCE_MI", kmToMi($"INS_TI_ECM_DISTANCE_KM")).
      withColumn("INS_TI_ENGINE_BRAKE_DISTANCE_MI", kmToMi($"INS_TI_ENGINE_BRAKE_DISTANCE_KM")).
      withColumn("INS_TI_ENGINE_DISTANCE_MI", kmToMi($"INS_TI_ENGINE_DISTANCE_KM")).
      withColumn("INS_TI_GEAR_DOWN_DISTANCE_MI", kmToMi($"INS_TI_GEAR_DOWN_DISTANCE_KM")).
      withColumn("INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_DISTANCE_MI", kmToMi($"INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_DISTANCE_KM")).
      withColumn("INS_TI_PREDICTIVE_CRUISE_CONTROL_DISTANCE_MI", kmToMi($"INS_TI_PREDICTIVE_CRUISE_CONTROL_DISTANCE_KM")).
      withColumn("INS_TI_SERVICE_BRAKE_DISTANCE_MI", kmToMi($"INS_TI_SERVICE_BRAKE_DISTANCE_KM")).
      withColumn("INS_TI_TOP_GEAR_DISTANCE_MI", kmToMi($"INS_TI_TOP_GEAR_DISTANCE_KM")).
      withColumn("INS_TI_TRIP_DRIVE_DISTANCE_MI", kmToMi($"INS_TI_TRIP_DRIVE_DISTANCE_KM")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_1_DISTANCE_MI", kmToMi($"INS_TI_VEHICLE_OVERSPEED_1_DISTANCE_KM")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_2_DISTANCE_MI", kmToMi($"INS_TI_VEHICLE_OVERSPEED_2_DISTANCE_KM")).
      withColumn("INS_TI_AVERAGE_VEHICLE_SPEED_MPH", kmToMi($"INS_TI_AVERAGE_VEHICLE_SPEED_KMPH")).
      withColumn("INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_MPH", kmToMi($"INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_KMPH")).
      withColumn("INS_TI_MAXIMUM_VEHICLE_SPEED_MPH", kmToMi($"INS_TI_MAXIMUM_VEHICLE_SPEED_KMPH")).
      withColumn("INS_TI_AVERAGE_FUEL_ECONOMY_MIPGAL", kmPerLToMiPerGal($"INS_TI_AVERAGE_FUEL_ECONOMY_KMPL")).
      withColumn("INS_TI_DRIVE_AVERAGE_FUEL_ECONOMY_MIPGAL", kmPerLToMiPerGal($"INS_TI_DRIVE_AVERAGE_FUEL_ECONOMY_KMPL")).
      withColumn("INS_TI_COAST_TIME_HOURS" , secToHr($"INS_TI_COAST_TIME_SECOND")).
      withColumn("INS_TI_CRUISE_CONTROL_TIME_HOURS" , secToHr($"INS_TI_CRUISE_CONTROL_TIME_SECOND")).
      withColumn("INS_TI_DRIVE_TIME_HOURS" , secToHr($"INS_TI_DRIVE_TIME_SECOND")).
      withColumn("INS_TI_ECM_TIME_KEY_ON_TIME_HOURS" , secToHr($"INS_TI_ECM_TIME_KEY_ON_TIME_SECOND")).
      withColumn("INS_TI_ENGINE_BRAKE_TIME_HOURS" , secToHr($"INS_TI_ENGINE_BRAKE_TIME_SECOND")).
      withColumn("INS_TI_ENGINE_PROTECTION_TIME_DERATED_HOURS" , secToHr($"INS_TI_ENGINE_PROTECTION_TIME_DERATED_SECOND")).
      withColumn("INS_TI_ENGINE_RUN_TIME_HOURS" , secToHr($"INS_TI_ENGINE_RUN_TIME_SECOND")).
      withColumn("INS_TI_FAN_ON_TIME_HOURS" , secToHr($"INS_TI_FAN_ON_TIME_SECOND")).
      withColumn("INS_TI_FAN_TIME_DUE_TO_AIR_CONDITIONING_PRESSURE_SWITCH_HOURS" , secToHr($"INS_TI_FAN_TIME_DUE_TO_AIR_CONDITIONING_PRESSURE_SWITCH_SECOND")).
      withColumn("INS_TI_FAN_TIME_DUE_TO_ENGINE_CONDITIONS_HOURS" , secToHr($"INS_TI_FAN_TIME_DUE_TO_ENGINE_CONDITIONS_SECOND")).
      withColumn("INS_TI_FAN_TIME_DUE_TO_FAN_CONTROL_SWITCH_HOURS" , secToHr($"INS_TI_FAN_TIME_DUE_TO_FAN_CONTROL_SWITCH_SECOND")).
      withColumn("INS_TI_FAN_TIME_WITHOUT_VEHICLE_SPEED_HOURS" , secToHr($"INS_TI_FAN_TIME_WITHOUT_VEHICLE_SPEED_SECOND")).
      withColumn("INS_TI_FAN_TIME_WITH_VEHICLE_SPEED_HOURS" , secToHr($"INS_TI_FAN_TIME_WITH_VEHICLE_SPEED_SECOND")).
      withColumn("INS_TI_FULL_LOAD_OPERATION_TIME_HOURS" , secToHr($"INS_TI_FULL_LOAD_OPERATION_TIME_SECOND")).
      withColumn("INS_TI_GEAR_DOWN_TIME_HOURS" , secToHr($"INS_TI_GEAR_DOWN_TIME_SECOND")).
      withColumn("INS_TI_IDLE_TIME_HOURS" , secToHr($"INS_TI_IDLE_TIME_SECOND")).
      withColumn("INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_TIME_HOURS" , secToHr($"INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_TIME_SECOND")).
      withColumn("INS_TI_OUT_OF_GEAR_COAST_TIME_HOURS" , secToHr($"INS_TI_OUT_OF_GEAR_COAST_TIME_SECOND")).
      withColumn("INS_TI_PREDICTIVE_CRUISE_CONTROL_TIME_HOURS" , secToHr($"INS_TI_PREDICTIVE_CRUISE_CONTROL_TIME_SECOND")).
      withColumn("INS_TI_SERVICE_BRAKE_TIME_HOURS" , secToHr($"INS_TI_SERVICE_BRAKE_TIME_SECOND")).
      withColumn("INS_TI_SMART_TORQUE_2_LEVEL_1_ECONOMY_TIME_HOURS" , secToHr($"INS_TI_SMART_TORQUE_2_LEVEL_1_ECONOMY_TIME_SECOND")).
      withColumn("INS_TI_SMART_TORQUE_2_LEVEL_2_ECONOMY_TIME_HOURS" , secToHr($"INS_TI_SMART_TORQUE_2_LEVEL_2_ECONOMY_TIME_SECOND")).
      withColumn("INS_TI_TOP_GEAR_TIME_HOURS" , secToHr($"INS_TI_TOP_GEAR_TIME_SECOND")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_1_TIME_HOURS" , secToHr($"INS_TI_VEHICLE_OVERSPEED_1_TIME_SECOND")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_2_TIME_HOURS" , secToHr($"INS_TI_VEHICLE_OVERSPEED_2_TIME_SECOND")).
	  withColumnRenamed("INS_TI_ENGINE_SERIAL_NUMBER_NONE","ESN").
	  withColumnRenamed("INS_TI_IMAGE_DATE_TIME","INS_IMAGE_TIMESTAMP")


	  
	  
==== 4

val intermediateDF = tripInfoCalDF.join(EAinfoDF, Seq("ESN", "INS_IMAGE_TIMESTAMP")).
      withColumn("INS_EA_CMP_COOLANT_TMP_SEC_SEV_TOTAL_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_EA_COOLANT_TMP_SEC_SEV_TOTAL", $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_EA_CMP_CRANKCASE_PRSR_SEV_TOTAL_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_EA_CRANKCASE_PRSR_SEC_SEV_TOTAL" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_EA_CMP_MANIFOLD_AIR_TMP_SEV_TOTAL_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_EA_MANIFOLD_AIR_TMP_SEC_SEV_TOTAL" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_EA_CMP_OIL_PRSR_SEV_TOTAL_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_EA_OIL_PRSR_SEC_SEV_TOTAL" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_EA_CMP_OIL_TMP_SEV_TOTAL_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_EA_OIL_TMP_SEC_SEV_TOTAL" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_EA_CMP_SPEED_SEV_TOTAL_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_EA_SPEED_SEC_SEV_TOTAL" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_DEF_USED_GAL_PER_MILE", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise($"INS_TI_AFTERTREATMENT_DIESEL_EXHAUST_FLUID_USED_GAL" / $"INS_TI_ENGINE_DISTANCE_MI")).
      withColumn("INS_TI_CMP_COAST_MILE_PERCENT", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise(getPercent($"INS_TI_COAST_DISTANCE_MI" , $"INS_TI_ENGINE_DISTANCE_MI"))).
      withColumn("INS_TI_CMP_COAST_FUEL_USED_PERCENT", when($"INS_TI_FUEL_USED_GAL" === 0, null).otherwise(getPercent($"INS_TI_COAST_FUEL_USED_GAL" , $"INS_TI_FUEL_USED_GAL"))).
      withColumn("INS_TI_CMP_COAST_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_COAST_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_CRUISE_MILE_PERCENT", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise(getPercent($"INS_TI_CRUISE_CONTROL_DISTANCE_MI" , $"INS_TI_ENGINE_DISTANCE_MI"))).
      withColumn("INS_TI_CMP_CRUISE_FUEL_USED_PERCENT", when($"INS_TI_FUEL_USED_GAL" === 0, null).otherwise(getPercent($"INS_TI_CRUISE_CONTROL_FUEL_USED_GAL" , $"INS_TI_FUEL_USED_GAL"))).
      withColumn("INS_TI_CMP_CRUISE_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_CRUISE_CONTROL_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_ENGINE_BRAKE_ACTIVATIONS_PER_MILE_NONE", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise($"INS_TI_ENGINE_BRAKE_ACTIVATIONS_NONE" / $"INS_TI_ENGINE_DISTANCE_MI")).
      withColumn("INS_TI_CMP_ENGINE_BRAKE_MILE_PERCENT", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise(getPercent($"INS_TI_ENGINE_BRAKE_DISTANCE_MI" , $"INS_TI_ENGINE_DISTANCE_MI"))).
      withColumn("INS_TI_CMP_ENGINE_PROTECTION_TIME_DERATED_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_ENGINE_PROTECTION_TIME_DERATED_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_FAN_ON_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_FAN_ON_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_FAN_TIME_DUE_TO_AIR_CONDITIONING_PRESSURE_SWITCH_PERCENT", when($"INS_TI_FAN_ON_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_FAN_TIME_DUE_TO_AIR_CONDITIONING_PRESSURE_SWITCH_HOURS" , $"INS_TI_FAN_ON_TIME_HOURS"))).
      withColumn("INS_TI_CMP_FAN_TIME_DUE_TO_ENGINE_CONDITIONS_PERCENT", when($"INS_TI_FAN_ON_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_FAN_TIME_DUE_TO_ENGINE_CONDITIONS_HOURS" , $"INS_TI_FAN_ON_TIME_HOURS"))).
      withColumn("INS_TI_CMP_FAN_TIME_DUE_TO_FAN_CONTROL_SWITCH_PERCENT", when($"INS_TI_FAN_ON_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_FAN_TIME_DUE_TO_FAN_CONTROL_SWITCH_HOURS" , $"INS_TI_FAN_ON_TIME_HOURS"))).
      withColumn("INS_TI_CMP_FAN_TIME_WITH_VEHICLE_SPEED_PERCENT", when($"INS_TI_FAN_ON_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_FAN_TIME_WITH_VEHICLE_SPEED_HOURS" , $"INS_TI_FAN_ON_TIME_HOURS"))).
      withColumn("INS_TI_CMP_FAN_TIME_WITHOUT_VEHICLE_SPEED_PERCENT", when($"INS_TI_FAN_ON_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_FAN_TIME_WITHOUT_VEHICLE_SPEED_HOURS" , $"INS_TI_FAN_ON_TIME_HOURS"))).
      withColumn("INS_TI_CMP_FUEL_CONSUMED_FOR_AFTERTREATMENT_INJECTION_GAL_PER_MILE", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise($"INS_TI_FUEL_CONSUMED_FOR_AFTERTREATMENT_INJECTION_GAL" / $"INS_TI_ENGINE_DISTANCE_MI")).
      withColumn("INS_TI_CMP_FULL_LOAD_OPERATION_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_FULL_LOAD_OPERATION_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_GEAR_DOWN_DISTANCE_PERCENT", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise(getPercent($"INS_TI_GEAR_DOWN_DISTANCE_MI" , $"INS_TI_ENGINE_DISTANCE_MI"))).
      withColumn("INS_TI_CMP_GEAR_DOWN_FUEL_USED_PERCENT", when($"INS_TI_FUEL_USED_GAL" === 0, null).otherwise(getPercent($"INS_TI_GEAR_DOWN_FUEL_USED_GAL" , $"INS_TI_FUEL_USED_GAL"))).
      withColumn("INS_TI_CMP_GEAR_DOWN_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_GEAR_DOWN_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_IDLE_FUEL_USED_PERCENT", when($"INS_TI_FUEL_USED_GAL" === 0, null).otherwise(getPercent($"INS_TI_IDLE_FUEL_USED_GAL" , $"INS_TI_FUEL_USED_GAL"))).
      withColumn("INS_TI_CMP_KEYSWITCH_CYCLES_PER_HOUR_NONE", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise($"INS_TI_KEYSWITCH_CYCLES_NONE" / $"INS_TI_ENGINE_RUN_TIME_HOURS")).
      withColumn("INS_TI_CMP_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_DISTANCE_PERCENT", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise(getPercent($"INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_DISTANCE_MI" , $"INS_TI_ENGINE_DISTANCE_MI"))).
      withColumn("INS_TI_CMP_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_FUEL_USED_PERCENT", when($"INS_TI_FUEL_USED_GAL" === 0, null).otherwise(getPercent($"INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_FUEL_USED_GAL" , $"INS_TI_FUEL_USED_GAL"))).
      withColumn("INS_TI_CMP_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_NUMBER_OF_COMPLETE_REGENERATIONS_PER_MILE", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise($"INS_TI_NUMBER_OF_COMPLETE_REGENERATIONS_NONE" / $"INS_TI_ENGINE_DISTANCE_MI")).
      withColumn("INS_TI_CMP_NUMBER_OF_IDLE_SHUTDOWN_OVERRIDES_PER_MILE", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise($"INS_TI_NUMBER_OF_IDLE_SHUTDOWN_OVERRIDES_NONE" / $"INS_TI_ENGINE_DISTANCE_MI")).
      withColumn("INS_TI_CMP_NUMBER_OF_IDLE_SHUTDOWNS_PER_MILE", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise($"INS_TI_NUMBER_OF_IDLE_SHUTDOWNS_NONE" / $"INS_TI_ENGINE_DISTANCE_MI")).
      withColumn("INS_TI_CMP_NUMBER_OF_INCOMPLETE_REGENERATIONS_PER_MILE", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise($"INS_TI_NUMBER_OF_INCOMPLETE_REGENERATIONS_NONE" / $"INS_TI_ENGINE_DISTANCE_MI")).
      withColumn("INS_TI_CMP_NUMBER_OF_SUDDEN_DECELERATIONS_PER_MILE", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise($"INS_TI_NUMBER_OF_SUDDEN_DECELERATIONS_NONE" / $"INS_TI_ENGINE_DISTANCE_MI")).
      withColumn("INS_TI_CMP_OUT_OF_GEAR_COAST_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_OUT_OF_GEAR_COAST_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_OUT_OF_GEAR_COASTS_PER_MILE", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise($"INS_TI_OUT_OF_GEAR_COASTS_NONE" / $"INS_TI_ENGINE_DISTANCE_MI")).
      withColumn("INS_TI_CMP_PREDICTIVE_CRUISE_CONTROL_DISTANCE_PERCENT", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise(getPercent($"INS_TI_PREDICTIVE_CRUISE_CONTROL_DISTANCE_MI" , $"INS_TI_ENGINE_DISTANCE_MI"))).
      withColumn("INS_TI_CMP_PREDICTIVE_CRUISE_CONTROL_FUEL_USED_PERCENT", when($"INS_TI_FUEL_USED_GAL" === 0, null).otherwise(getPercent($"INS_TI_PREDICTIVE_CRUISE_CONTROL_FUEL_USED_GAL" , $"INS_TI_FUEL_USED_GAL"))).
      withColumn("INS_TI_CMP_PREDICTIVE_CRUISE_CONTROL_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_PREDICTIVE_CRUISE_CONTROL_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_SERVICE_BRAKE_ACTUATIONS_PER_MILE", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise($"INS_TI_SERVICE_BRAKE_ACTUATIONS_NONE" / $"INS_TI_ENGINE_DISTANCE_MI")).
      withColumn("INS_TI_CMP_SERVICE_BRAKE_DISTANCE_PERCENT", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise(getPercent($"INS_TI_SERVICE_BRAKE_DISTANCE_MI" , $"INS_TI_ENGINE_DISTANCE_MI"))).
      withColumn("INS_TI_CMP_SERVICE_BRAKE_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_SERVICE_BRAKE_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_SMART_TORQUE_2_LEVEL_1_ECONOMY_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_SMART_TORQUE_2_LEVEL_1_ECONOMY_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_SMART_TORQUE_2_LEVEL_1_ECONOMY_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_SMART_TORQUE_2_LEVEL_2_ECONOMY_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_TOP_GEAR_DISTANCE_PERCENT", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise(getPercent($"INS_TI_TOP_GEAR_DISTANCE_MI" , $"INS_TI_ENGINE_DISTANCE_MI"))).
      withColumn("INS_TI_CMP_TOP_GEAR_FUEL_USED_PERCENT", when($"INS_TI_FUEL_USED_GAL" === 0, null).otherwise(getPercent($"INS_TI_TOP_GEAR_FUEL_USED_GAL" , $"INS_TI_FUEL_USED_GAL"))).
      withColumn("INS_TI_CMP_TOP_GEAR_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_TOP_GEAR_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_VEHICLE_OVERSPEED_1_DISTANCE_PERCENT", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise(getPercent($"INS_TI_VEHICLE_OVERSPEED_1_DISTANCE_MI" , $"INS_TI_ENGINE_DISTANCE_MI"))).
      withColumn("INS_TI_CMP_VEHICLE_OVERSPEED_1_FUEL_USED_PERCENT", when($"INS_TI_FUEL_USED_GAL" === 0, null).otherwise(getPercent($"INS_TI_VEHICLE_OVERSPEED_1_FUEL_USED_GAL" , $"INS_TI_FUEL_USED_GAL"))).
      withColumn("INS_TI_CMP_VEHICLE_OVERSPEED_1_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_VEHICLE_OVERSPEED_1_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS"))).
      withColumn("INS_TI_CMP_VEHICLE_OVERSPEED_2_DISTANCE_PERCENT", when($"INS_TI_ENGINE_DISTANCE_MI" === 0, null).otherwise(getPercent($"INS_TI_VEHICLE_OVERSPEED_2_DISTANCE_MI" , $"INS_TI_ENGINE_DISTANCE_MI"))).
      withColumn("INS_TI_CMP_VEHICLE_OVERSPEED_2_FUEL_USED_PERCENT", when($"INS_TI_FUEL_USED_GAL" === 0, null).otherwise(getPercent($"INS_TI_VEHICLE_OVERSPEED_2_FUEL_USED_GAL" , $"INS_TI_FUEL_USED_GAL"))).
      withColumn("INS_TI_CMP_VEHICLE_OVERSPEED_2_TIME_PERCENT", when($"INS_TI_ENGINE_RUN_TIME_HOURS" === 0, null).otherwise(getPercent($"INS_TI_VEHICLE_OVERSPEED_2_TIME_HOURS" , $"INS_TI_ENGINE_RUN_TIME_HOURS")))

	  
	  
========  5


select the required from the above generated data frame and take the values into Excel as discussed in yesterday meeting 

use below command for selecting the columns :


intermediateDF.select("INS_EA_COOLANT_TMP_SEC_SEV_TOTAL","INS_TI_ENGINE_RUN_TIME_HOURS","INS_EA_CMP_COOLANT_TMP_SEC_SEV_TOTAL_PERCENT").show(60)


=============================================================================================================================================================

=== Target Table Validations 

==== Step 1

Table path :

quality_x15_test_mi.full_features_ins_unit_chng_nn730


Reading the table into Dataframe

val targetDF = spark.sql("select * from quality_x15_test_mi.full_features_ins_unit_chng_nn730")


==== Step 2

val targetCalDF = targetDF.withColumn("INS_TI_AFTERTREATMENT_DIESEL_EXHAUST_FLUID_USED_GAL",lToGal($"INS_TI_AFTERTREATMENT_DIESEL_EXHAUST_FLUID_USED_LITRE")).
      withColumn("INS_TI_COAST_FUEL_USED_GAL",lToGal($"INS_TI_COAST_FUEL_USED_LITRE")).
      withColumn("INS_TI_CRUISE_CONTROL_FUEL_USED_GAL",lToGal($"INS_TI_CRUISE_CONTROL_FUEL_USED_LITRE")).
      withColumn("INS_TI_DRIVE_FUEL_USED_GAL",lToGal($"INS_TI_DRIVE_FUEL_USED_LITRE")).
      withColumn("INS_TI_FUEL_CONSUMED_FOR_AFTERTREATMENT_INJECTION_GAL",lToGal($"INS_TI_FUEL_CONSUMED_FOR_AFTERTREATMENT_INJECTION_LITRE")).
      withColumn("INS_TI_FUEL_USED_GAL",lToGal($"INS_TI_FUEL_USED_LITRE")).
      withColumn("INS_TI_GEAR_DOWN_FUEL_USED_GAL",lToGal($"INS_TI_GEAR_DOWN_FUEL_USED_LITRE")).
      withColumn("INS_TI_IDLE_FUEL_USED_GAL",lToGal($"INS_TI_IDLE_FUEL_USED_LITRE")).
      withColumn("INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_FUEL_USED_GAL",lToGal($"INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_FUEL_USED_LITRE")).
      withColumn("INS_TI_PREDICTIVE_CRUISE_CONTROL_FUEL_USED_GAL",lToGal($"INS_TI_PREDICTIVE_CRUISE_CONTROL_FUEL_USED_LITRE")).
      withColumn("INS_TI_TOP_GEAR_FUEL_USED_GAL",lToGal($"INS_TI_TOP_GEAR_FUEL_USED_LITRE")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_1_FUEL_USED_GAL",lToGal($"INS_TI_VEHICLE_OVERSPEED_1_FUEL_USED_LITRE")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_2_FUEL_USED_GAL",lToGal($"INS_TI_VEHICLE_OVERSPEED_2_FUEL_USED_LITRE")).
      withColumn("INS_TI_COAST_DISTANCE_MI", kmToMi($"INS_TI_COAST_DISTANCE_KM")).
      withColumn("INS_TI_CRUISE_CONTROL_DISTANCE_MI", kmToMi($"INS_TI_CRUISE_CONTROL_DISTANCE_KM")).
      withColumn("INS_TI_ECM_DISTANCE_MI", kmToMi($"INS_TI_ECM_DISTANCE_KM")).
      withColumn("INS_TI_ENGINE_BRAKE_DISTANCE_MI", kmToMi($"INS_TI_ENGINE_BRAKE_DISTANCE_KM")).
      withColumn("INS_TI_ENGINE_DISTANCE_MI", kmToMi($"INS_TI_ENGINE_DISTANCE_KM")).
      withColumn("INS_TI_GEAR_DOWN_DISTANCE_MI", kmToMi($"INS_TI_GEAR_DOWN_DISTANCE_KM")).
      withColumn("INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_DISTANCE_MI", kmToMi($"INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_DISTANCE_KM")).
      withColumn("INS_TI_PREDICTIVE_CRUISE_CONTROL_DISTANCE_MI", kmToMi($"INS_TI_PREDICTIVE_CRUISE_CONTROL_DISTANCE_KM")).
      withColumn("INS_TI_SERVICE_BRAKE_DISTANCE_MI", kmToMi($"INS_TI_SERVICE_BRAKE_DISTANCE_KM")).
      withColumn("INS_TI_TOP_GEAR_DISTANCE_MI", kmToMi($"INS_TI_TOP_GEAR_DISTANCE_KM")).
      withColumn("INS_TI_TRIP_DRIVE_DISTANCE_MI", kmToMi($"INS_TI_TRIP_DRIVE_DISTANCE_KM")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_1_DISTANCE_MI", kmToMi($"INS_TI_VEHICLE_OVERSPEED_1_DISTANCE_KM")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_2_DISTANCE_MI", kmToMi($"INS_TI_VEHICLE_OVERSPEED_2_DISTANCE_KM")).
      withColumn("INS_TI_AVERAGE_VEHICLE_SPEED_MPH", kmToMi($"INS_TI_AVERAGE_VEHICLE_SPEED_KMPH")).
      withColumn("INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_MPH", kmToMi($"INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_KMPH")).
      withColumn("INS_TI_MAXIMUM_VEHICLE_SPEED_MPH", kmToMi($"INS_TI_MAXIMUM_VEHICLE_SPEED_KMPH")).
      withColumn("INS_TI_AVERAGE_FUEL_ECONOMY_MIPGAL", kmPerLToMiPerGal($"INS_TI_AVERAGE_FUEL_ECONOMY_KMPL")).
      withColumn("INS_TI_DRIVE_AVERAGE_FUEL_ECONOMY_MIPGAL", kmPerLToMiPerGal($"INS_TI_DRIVE_AVERAGE_FUEL_ECONOMY_KMPL")).
      withColumn("INS_TI_COAST_TIME_HOURS" , secToHr($"INS_TI_COAST_TIME_SECOND")).
      withColumn("INS_TI_CRUISE_CONTROL_TIME_HOURS" , secToHr($"INS_TI_CRUISE_CONTROL_TIME_SECOND")).
      withColumn("INS_TI_DRIVE_TIME_HOURS" , secToHr($"INS_TI_DRIVE_TIME_SECOND")).
      withColumn("INS_TI_ECM_TIME_KEY_ON_TIME_HOURS" , secToHr($"INS_TI_ECM_TIME_KEY_ON_TIME_SECOND")).
      withColumn("INS_TI_ENGINE_BRAKE_TIME_HOURS" , secToHr($"INS_TI_ENGINE_BRAKE_TIME_SECOND")).
      withColumn("INS_TI_ENGINE_PROTECTION_TIME_DERATED_HOURS" , secToHr($"INS_TI_ENGINE_PROTECTION_TIME_DERATED_SECOND")).
      withColumn("INS_TI_ENGINE_RUN_TIME_HOURS" , secToHr($"INS_TI_ENGINE_RUN_TIME_SECOND")).
      withColumn("INS_TI_FAN_ON_TIME_HOURS" , secToHr($"INS_TI_FAN_ON_TIME_SECOND")).
      withColumn("INS_TI_FAN_TIME_DUE_TO_AIR_CONDITIONING_PRESSURE_SWITCH_HOURS" , secToHr($"INS_TI_FAN_TIME_DUE_TO_AIR_CONDITIONING_PRESSURE_SWITCH_SECOND")).
      withColumn("INS_TI_FAN_TIME_DUE_TO_ENGINE_CONDITIONS_HOURS" , secToHr($"INS_TI_FAN_TIME_DUE_TO_ENGINE_CONDITIONS_SECOND")).
      withColumn("INS_TI_FAN_TIME_DUE_TO_FAN_CONTROL_SWITCH_HOURS" , secToHr($"INS_TI_FAN_TIME_DUE_TO_FAN_CONTROL_SWITCH_SECOND")).
      withColumn("INS_TI_FAN_TIME_WITHOUT_VEHICLE_SPEED_HOURS" , secToHr($"INS_TI_FAN_TIME_WITHOUT_VEHICLE_SPEED_SECOND")).
      withColumn("INS_TI_FAN_TIME_WITH_VEHICLE_SPEED_HOURS" , secToHr($"INS_TI_FAN_TIME_WITH_VEHICLE_SPEED_SECOND")).
      withColumn("INS_TI_FULL_LOAD_OPERATION_TIME_HOURS" , secToHr($"INS_TI_FULL_LOAD_OPERATION_TIME_SECOND")).
      withColumn("INS_TI_GEAR_DOWN_TIME_HOURS" , secToHr($"INS_TI_GEAR_DOWN_TIME_SECOND")).
      withColumn("INS_TI_IDLE_TIME_HOURS" , secToHr($"INS_TI_IDLE_TIME_SECOND")).
      withColumn("INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_TIME_HOURS" , secToHr($"INS_TI_MAXIMUM_ACCELERATOR_VEHICLE_SPEED_TIME_SECOND")).
      withColumn("INS_TI_OUT_OF_GEAR_COAST_TIME_HOURS" , secToHr($"INS_TI_OUT_OF_GEAR_COAST_TIME_SECOND")).
      withColumn("INS_TI_PREDICTIVE_CRUISE_CONTROL_TIME_HOURS" , secToHr($"INS_TI_PREDICTIVE_CRUISE_CONTROL_TIME_SECOND")).
      withColumn("INS_TI_SERVICE_BRAKE_TIME_HOURS" , secToHr($"INS_TI_SERVICE_BRAKE_TIME_SECOND")).
      withColumn("INS_TI_SMART_TORQUE_2_LEVEL_1_ECONOMY_TIME_HOURS" , secToHr($"INS_TI_SMART_TORQUE_2_LEVEL_1_ECONOMY_TIME_SECOND")).
      withColumn("INS_TI_SMART_TORQUE_2_LEVEL_2_ECONOMY_TIME_HOURS" , secToHr($"INS_TI_SMART_TORQUE_2_LEVEL_2_ECONOMY_TIME_SECOND")).
      withColumn("INS_TI_TOP_GEAR_TIME_HOURS" , secToHr($"INS_TI_TOP_GEAR_TIME_SECOND")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_1_TIME_HOURS" , secToHr($"INS_TI_VEHICLE_OVERSPEED_1_TIME_SECOND")).
      withColumn("INS_TI_VEHICLE_OVERSPEED_2_TIME_HOURS" , secToHr($"INS_TI_VEHICLE_OVERSPEED_2_TIME_SECOND"))


	  
===== Step 3

1 == filter the three columns presented in Excel and note the values, 

2 == Validate them with the manual calculations 

targetCalDF.select("INS_EA_COOLANT_TMP_SEC_SEV_TOTAL","INS_TI_ENGINE_RUN_TIME_HOURS","INS_EA_CMP_COOLANT_TMP_SEC_SEV_TOTAL_PERCENT").show(60)

